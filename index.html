<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GMR Lorraine - R√©servation V√©hicules</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0f172a">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* ============================================================
           RESET & BASE
           ============================================================ */
        *, *::before, *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* ============================================================
           THEME SYSTEM ‚Äî 7 refined professional palettes
           ============================================================ */
        :root {
            /* ‚îÄ‚îÄ Corporate Steel (default) ‚îÄ‚îÄ */
            --bg-primary:    #0a0e1a;
            --bg-secondary:  #111827;
            --bg-tertiary:   #1c2434;
            --card-bg:       rgba(30,41,59,.45);
            --border-color:  rgba(100,120,160,.18);
            --primary:       #4f81c9;
            --secondary:     #6c7dd4;
            --accent:        #8b72d6;
            --success:       #34c38f;
            --warning:       #f0ad4e;
            --danger:        #e74c5a;
            --text-primary:  #eef0f4;
            --text-secondary:#7c8da5;
            --glow:          rgba(79,129,201,.25);
            --shadow:        rgba(79,129,201,.12);
            --glass:         rgba(17,24,39,.7);
        }

        /* ‚îÄ‚îÄ Slate Office ‚îÄ‚îÄ */
        [data-theme="slate"] {
            --bg-primary:    #f0f2f5;
            --bg-secondary:  #ffffff;
            --bg-tertiary:   #e8eaee;
            --card-bg:       rgba(255,255,255,.85);
            --border-color:  rgba(0,0,0,.08);
            --primary:       #2c5282;
            --secondary:     #3182ce;
            --accent:        #4299e1;
            --success:       #2f855a;
            --warning:       #d69e2e;
            --danger:        #e53e3e;
            --text-primary:  #1a202c;
            --text-secondary:#718096;
            --glow:          rgba(44,82,130,.18);
            --shadow:        rgba(44,82,130,.1);
            --glass:         rgba(255,255,255,.88);
        }

        /* ‚îÄ‚îÄ Midnight Ink ‚îÄ‚îÄ */
        [data-theme="midnight"] {
            --bg-primary:    #060b16;
            --bg-secondary:  #0d1520;
            --bg-tertiary:   #162231;
            --card-bg:       rgba(13,21,32,.7);
            --border-color:  rgba(60,130,200,.15);
            --primary:       #38bdf8;
            --secondary:     #0ea5e9;
            --accent:        #7dd3fc;
            --success:       #22d3ee;
            --warning:       #fbbf24;
            --danger:        #f87171;
            --text-primary:  #e0f2fe;
            --text-secondary:#4d9cb5;
            --glow:          rgba(56,189,248,.22);
            --shadow:        rgba(56,189,248,.1);
            --glass:         rgba(13,21,32,.8);
        }

        /* ‚îÄ‚îÄ Charcoal Gold ‚îÄ‚îÄ */
        [data-theme="gold"] {
            --bg-primary:    #111110;
            --bg-secondary:  #1a1a18;
            --bg-tertiary:   #252521;
            --card-bg:       rgba(26,26,24,.75);
            --border-color:  rgba(195,163,92,.2);
            --primary:       #c3a35c;
            --secondary:     #d4af37;
            --accent:        #e8c96d;
            --success:       #52c41a;
            --warning:       #faad14;
            --danger:        #ff4d4f;
            --text-primary:  #f5f0e0;
            --text-secondary:#8a8268;
            --glow:          rgba(195,163,92,.22);
            --shadow:        rgba(195,163,92,.1);
            --glass:         rgba(26,26,24,.82);
        }

        /* ‚îÄ‚îÄ Deep Teal ‚îÄ‚îÄ */
        [data-theme="teal"] {
            --bg-primary:    #031a1a;
            --bg-secondary:  #062626;
            --bg-tertiary:   #0d3535;
            --card-bg:       rgba(6,38,38,.7);
            --border-color:  rgba(20,184,166,.18);
            --primary:       #14b8a6;
            --secondary:     #0d9488;
            --accent:        #2dd4bf;
            --success:       #34d399;
            --warning:       #f59e0b;
            --danger:        #f43f5e;
            --text-primary:  #ccfbf1;
            --text-secondary:#5eafa0;
            --glow:          rgba(20,184,166,.22);
            --shadow:        rgba(20,184,166,.1);
            --glass:         rgba(6,38,38,.82);
        }

        /* ‚îÄ‚îÄ Wine & Stone ‚îÄ‚îÄ */
        [data-theme="wine"] {
            --bg-primary:    #1a1012;
            --bg-secondary:  #241518;
            --bg-tertiary:   #301c20;
            --card-bg:       rgba(36,21,24,.7);
            --border-color:  rgba(180,63,90,.2);
            --primary:       #b43f5a;
            --secondary:     #9f3454;
            --accent:        #d4778f;
            --success:       #4ade80;
            --warning:       #fbbf24;
            --danger:        #f43f5e;
            --text-primary:  #f9e0e4;
            --text-secondary:#8a6068;
            --glow:          rgba(180,63,90,.22);
            --shadow:        rgba(180,63,90,.1);
            --glass:         rgba(36,21,24,.82);
        }

        /* ‚îÄ‚îÄ Arctic ‚îÄ‚îÄ */
        [data-theme="arctic"] {
            --bg-primary:    #f1f5f9;
            --bg-secondary:  #ffffff;
            --bg-tertiary:   #e2e8f0;
            --card-bg:       rgba(255,255,255,.9);
            --border-color:  rgba(0,0,0,.07);
            --primary:       #0369a1;
            --secondary:     #0284c7;
            --accent:        #38bdf8;
            --success:       #059669;
            --warning:       #d97706;
            --danger:        #dc2626;
            --text-primary:  #0c1829;
            --text-secondary:#64748b;
            --glow:          rgba(3,105,161,.14);
            --shadow:        rgba(3,105,161,.08);
            --glass:         rgba(255,255,255,.9);
        }

        /* ============================================================
           TYPOGRAPHY & BODY
           ============================================================ */
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            transition: background .4s ease, color .4s ease;
            -webkit-font-smoothing: antialiased;
        }

        /* subtle ambient gradient */
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background:
                radial-gradient(ellipse 60% 50% at 15% 20%, var(--primary), transparent),
                radial-gradient(ellipse 50% 45% at 85% 75%, var(--secondary), transparent);
            opacity: .06;
            pointer-events: none;
            z-index: 0;
        }

        .container {
            position: relative;
            z-index: 1;
            max-width: 1360px;
            margin: 0 auto;
            padding: 24px 20px;
        }

        /* ============================================================
           PUSH-NOTIFICATION BANNER  (requests permission)
           ============================================================ */
        .push-banner {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            z-index: 8000;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            backdrop-filter: blur(14px);
            padding: 18px 24px;
            display: flex;
            align-items: center;
            gap: 16px;
            box-shadow: 0 -4px 24px rgba(0,0,0,.3);
            transform: translateY(100%);
            transition: transform .4s cubic-bezier(.34,1.56,.64,1);
        }
        .push-banner.visible { transform: translateY(0); }
        .push-banner__icon { font-size: 1.6rem; flex-shrink: 0; }
        .push-banner__text { flex: 1; font-size: .88rem; color: var(--text-secondary); line-height: 1.5; }
        .push-banner__text strong { color: var(--text-primary); }
        .push-banner__btn {
            padding: 10px 22px;
            background: var(--primary);
            border: none;
            border-radius: 8px;
            color: #fff;
            font-weight: 700;
            font-size: .82rem;
            letter-spacing: .6px;
            text-transform: uppercase;
            cursor: pointer;
            transition: opacity .2s, transform .15s;
            flex-shrink: 0;
        }
        .push-banner__btn:hover { opacity: .85; transform: scale(1.03); }
        .push-banner__dismiss {
            background: none; border: none;
            color: var(--text-secondary);
            font-size: 1.3rem; cursor: pointer;
            transition: color .2s;
            flex-shrink: 0;
        }
        .push-banner__dismiss:hover { color: var(--text-primary); }

        /* ============================================================
           TOAST NOTIFICATIONS  (in-page)
           ============================================================ */
        .toast-wrap {
            position: fixed;
            top: 24px; right: 24px;
            z-index: 9000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 380px;
            width: calc(100% - 48px);
            pointer-events: none;
        }
        .toast {
            pointer-events: auto;
            display: flex;
            align-items: flex-start;
            gap: 14px;
            background: var(--glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px 18px;
            box-shadow: 0 8px 32px var(--shadow);
            animation: toastIn .35s cubic-bezier(.34,1.56,.64,1) forwards;
            position: relative;
            overflow: hidden;
        }
        .toast::before {
            content: '';
            position: absolute;
            left: 0; top: 0;
            width: 3px; height: 100%;
        }
        .toast.success::before { background: var(--success); }
        .toast.error::before   { background: var(--danger); }
        .toast.warning::before { background: var(--warning); }
        .toast.info::before    { background: var(--primary); }

        .toast__icon {
            font-size: 1.15rem;
            flex-shrink: 0;
            width: 28px; height: 28px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
        }
        .toast.success .toast__icon { background: rgba(52,195,143,.15); color: var(--success); }
        .toast.error   .toast__icon { background: rgba(231,76,90,.15);  color: var(--danger); }
        .toast.warning .toast__icon { background: rgba(240,173,78,.15); color: var(--warning); }
        .toast.info    .toast__icon { background: rgba(79,129,201,.15); color: var(--primary); }

        .toast__body { flex: 1; min-width: 0; }
        .toast__title { font-weight: 700; font-size: .88rem; color: var(--text-primary); margin-bottom: 3px; }
        .toast__msg   { font-size: .8rem; color: var(--text-secondary); line-height: 1.45; }
        .toast__close {
            background: none; border: none;
            color: var(--text-secondary);
            font-size: 1.1rem; cursor: pointer;
            line-height: 1;
            transition: color .2s;
            flex-shrink: 0;
        }
        .toast__close:hover { color: var(--text-primary); }
        .toast.out { animation: toastOut .25s ease forwards; }

        @keyframes toastIn {
            from { opacity: 0; transform: translateX(110%); }
            to   { opacity: 1; transform: translateX(0); }
        }
        @keyframes toastOut {
            from { opacity: 1; transform: translateX(0); max-height: 200px; margin-bottom: 10px; }
            to   { opacity: 0; transform: translateX(110%); max-height: 0; margin-bottom: 0; padding: 0; }
        }

        /* ============================================================
           THEME SWITCHER
           ============================================================ */
        .theme-rail {
            position: fixed;
            top: 24px; left: 24px;
            z-index: 1000;
        }
        .theme-toggle {
            width: 44px; height: 44px;
            border-radius: 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            backdrop-filter: blur(14px);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 16px var(--shadow);
            transition: transform .2s, box-shadow .2s;
        }
        .theme-toggle:hover { transform: scale(1.06); box-shadow: 0 6px 22px var(--glow); }
        .theme-toggle svg { width: 20px; height: 20px; stroke: var(--text-primary); fill: none; stroke-width: 1.8; }

        .theme-panel {
            position: absolute;
            top: 52px; left: 0;
            width: 220px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 14px;
            padding: 10px;
            box-shadow: 0 12px 40px rgba(0,0,0,.3);
            backdrop-filter: blur(18px);
            opacity: 0;
            pointer-events: none;
            transform: translateY(-6px);
            transition: opacity .22s, transform .22s;
        }
        .theme-panel.open {
            opacity: 1;
            pointer-events: auto;
            transform: translateY(0);
        }
        .theme-panel__label {
            font-size: .7rem;
            font-weight: 700;
            letter-spacing: 1.2px;
            text-transform: uppercase;
            color: var(--text-secondary);
            padding: 6px 10px 2px;
        }
        .theme-row {
            display: flex; align-items: center; gap: 10px;
            padding: 9px 10px;
            border-radius: 9px;
            cursor: pointer;
            transition: background .18s;
            border: 1.5px solid transparent;
        }
        .theme-row:hover { background: var(--card-bg); }
        .theme-row.active { border-color: var(--primary); background: var(--card-bg); }
        .theme-row__swatch {
            width: 28px; height: 28px;
            border-radius: 7px;
            border: 1.5px solid var(--border-color);
            flex-shrink: 0;
        }
        .theme-row__name { font-size: .82rem; font-weight: 600; color: var(--text-primary); }

        /* ============================================================
           TOP BAR  (action buttons)
           ============================================================ */
        .topbar {
            position: fixed;
            top: 24px; right: 24px;
            z-index: 1000;
            display: flex; gap: 10px;
        }
        .topbar__btn {
            padding: 10px 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            font-weight: 600;
            font-size: .82rem;
            letter-spacing: .5px;
            cursor: pointer;
            backdrop-filter: blur(14px);
            box-shadow: 0 4px 14px var(--shadow);
            transition: all .22s;
        }
        .topbar__btn:hover {
            border-color: var(--primary);
            background: var(--primary);
            color: #fff;
            transform: translateY(-1px);
            box-shadow: 0 6px 20px var(--glow);
        }

        /* ============================================================
           HEADER
           ============================================================ */
        header {
            text-align: center;
            padding: 72px 20px 44px;
            margin-bottom: 36px;
        }
        h1 {
            font-family: 'Poppins', sans-serif;
            font-size: clamp(2.4rem, 5.5vw, 3.8rem);
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary), var(--secondary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -1.5px;
            margin-bottom: 10px;
        }
        .subtitle {
            font-size: .82rem;
            color: var(--text-secondary);
            font-weight: 500;
            letter-spacing: 3.5px;
            text-transform: uppercase;
        }

        /* ============================================================
           VEHICLE GRID
           ============================================================ */
        .vehicles-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(310px, 1fr));
            gap: 20px;
            margin-bottom: 56px;
        }
        .vehicle-card {
            background: var(--card-bg);
            backdrop-filter: blur(18px);
            border: 1px solid var(--border-color);
            border-radius: 14px;
            padding: 24px;
            cursor: pointer;
            transition: transform .25s, border-color .25s, box-shadow .25s;
            box-shadow: 0 4px 20px var(--shadow);
            position: relative;
            overflow: hidden;
        }
        .vehicle-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            opacity: 0;
            transition: opacity .25s;
        }
        .vehicle-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
            box-shadow: 0 12px 36px var(--glow);
        }
        .vehicle-card:hover::before { opacity: 1; }

        .vehicle-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 18px;
        }
        .vehicle-name {
            font-family: 'Poppins', sans-serif;
            font-size: 1.35rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        .vehicle-badge {
            padding: 5px 13px;
            border-radius: 20px;
            font-size: .7rem;
            font-weight: 700;
            letter-spacing: .8px;
            text-transform: uppercase;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
        }
        .vehicle-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }
        .info-item {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 9px;
            padding: 12px 14px;
            transition: border-color .2s;
        }
        .info-item:hover { border-color: var(--primary); }
        .info-label {
            font-size: .65rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 4px;
        }
        .info-value {
            font-weight: 700;
            font-size: .95rem;
            color: var(--text-primary);
        }
        .reserve-btn {
            width: 100%;
            padding: 13px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border: none;
            border-radius: 9px;
            color: #fff;
            font-weight: 700;
            font-size: .8rem;
            letter-spacing: 1px;
            text-transform: uppercase;
            cursor: pointer;
            transition: transform .2s, box-shadow .2s;
            box-shadow: 0 3px 12px var(--shadow);
        }
        .reserve-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px var(--glow);
        }

        /* ============================================================
           SECTION TITLE
           ============================================================ */
        .section-title {
            font-family: 'Poppins', sans-serif;
            font-size: 1.7rem;
            font-weight: 700;
            text-align: center;
            color: var(--text-primary);
            margin: 56px 0 32px;
            position: relative;
            padding-bottom: 16px;
        }
        .section-title::after {
            content: '';
            position: absolute;
            bottom: 0; left: 50%;
            transform: translateX(-50%);
            width: 48px; height: 3px;
            border-radius: 2px;
            background: linear-gradient(90deg, var(--primary), var(--accent));
        }

        /* ============================================================
           RESERVATION CARDS
           ============================================================ */
        .reservation-card {
            background: var(--card-bg);
            backdrop-filter: blur(18px);
            border: 1px solid var(--border-color);
            border-radius: 14px;
            padding: 24px;
            margin-bottom: 18px;
            transition: transform .25s, border-color .25s, box-shadow .25s;
            box-shadow: 0 4px 20px var(--shadow);
        }
        .reservation-card:hover {
            transform: translateY(-3px);
            border-color: var(--primary);
            box-shadow: 0 10px 32px var(--glow);
        }
        .reservation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }
        .reservation-vehicle-info { display: flex; align-items: center; gap: 14px; }
        .vehicle-icon { font-size: 2rem; }
        .vehicle-details h3 {
            font-family: 'Poppins', sans-serif;
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 3px;
        }
        .vehicle-plate {
            font-family: 'Courier New', monospace;
            font-size: .78rem;
            color: var(--text-secondary);
            letter-spacing: 2px;
        }
        .reservation-status {
            padding: 6px 16px;
            border-radius: 18px;
            font-size: .7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: .8px;
            background: rgba(79,129,201,.12);
            border: 1px solid var(--primary);
            color: var(--primary);
        }
        .reservation-body {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 14px;
            margin: 16px 0;
        }
        .reservation-info-block h4 {
            color: var(--text-secondary);
            font-size: .68rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 6px;
        }
        .reservation-info-block p {
            font-size: .92rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        .time-range { display: flex; align-items: center; gap: 8px; font-size: .92rem; font-weight: 600; }
        .time-arrow { color: var(--primary); }
        .reservation-destination { grid-column: 1 / -1; }

        .reservation-actions {
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
        }
        .unlock-btn {
            padding: 11px 22px;
            background: rgba(231,76,90,.08);
            border: 1.5px solid var(--danger);
            border-radius: 9px;
            color: var(--danger);
            font-weight: 700;
            font-size: .78rem;
            letter-spacing: .8px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all .22s;
        }
        .unlock-btn:hover {
            background: var(--danger);
            color: #fff;
            box-shadow: 0 6px 18px rgba(231,76,90,.3);
            transform: translateY(-1px);
        }

        /* ============================================================
           EMPTY STATE
           ============================================================ */
        .empty-state {
            text-align: center;
            padding: 56px 20px;
            color: var(--text-secondary);
            font-size: .9rem;
        }
        .empty-state-icon { font-size: 2.8rem; margin-bottom: 12px; opacity: .45; }

        /* ============================================================
           MODALS
           ============================================================ */
        .modal {
            display: none;
            position: fixed; inset: 0;
            background: rgba(0,0,0,.6);
            backdrop-filter: blur(6px);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .modal.active {
            display: flex;
            animation: mIn .2s ease;
        }
        @keyframes mIn { from { opacity: 0; } to { opacity: 1; } }

        .modal-content {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 32px;
            max-width: 600px;
            width: 100%;
            max-height: 88vh;
            overflow-y: auto;
            animation: mUp .28s cubic-bezier(.34,1.56,.64,1);
            box-shadow: 0 24px 60px rgba(0,0,0,.45);
        }
        @keyframes mUp {
            from { opacity: 0; transform: translateY(28px); }
            to   { opacity: 1; transform: translateY(0); }
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 18px;
            border-bottom: 1px solid var(--border-color);
        }
        .modal-title {
            font-family: 'Poppins', sans-serif;
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--primary);
        }
        .close-btn {
            background: none; border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            width: 30px; height: 30px;
            display: flex; align-items: center; justify-content: center;
            border-radius: 7px;
            transition: all .18s;
        }
        .close-btn:hover { color: var(--danger); background: var(--card-bg); }

        /* ‚îÄ‚îÄ Form Controls ‚îÄ‚îÄ */
        .form-group { margin-bottom: 18px; }
        .form-label { display: block; margin-bottom: 7px; font-weight: 600; font-size: .82rem; color: var(--text-primary); }
        .form-input, .form-select {
            width: 100%;
            padding: 12px 14px;
            background: var(--bg-tertiary);
            border: 1.5px solid var(--border-color);
            border-radius: 9px;
            color: var(--text-primary);
            font-size: .88rem;
            transition: border-color .2s, box-shadow .2s;
        }
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79,129,201,.12);
        }
        .form-select { cursor: pointer; }
        .form-select option { background: var(--bg-secondary); color: var(--text-primary); }
        .submit-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border: none;
            border-radius: 9px;
            color: #fff;
            font-weight: 700;
            font-size: .84rem;
            letter-spacing: 1px;
            text-transform: uppercase;
            cursor: pointer;
            transition: transform .2s, box-shadow .2s;
        }
        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px var(--glow);
        }

        /* ‚îÄ‚îÄ Time Slots ‚îÄ‚îÄ */
        .time-slots-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(68px, 1fr));
            gap: 7px;
            margin-top: 10px;
        }
        .time-slot {
            padding: 10px 4px;
            background: var(--bg-tertiary);
            border: 1.5px solid var(--border-color);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            font-size: .78rem;
            color: var(--text-primary);
            transition: all .18s;
        }
        .time-slot:hover:not(.occupied):not(.disabled) {
            border-color: var(--primary);
            background: var(--card-bg);
            transform: translateY(-1px);
        }
        .time-slot.selected { background: var(--primary); border-color: var(--primary); color: #fff; }
        .time-slot.occupied { background: rgba(231,76,90,.08); border-color: rgba(231,76,90,.25); opacity: .5; cursor: not-allowed; }
        .time-slot.disabled { opacity: .28; cursor: not-allowed; }

        /* ============================================================
           ADMIN PANEL EXTRAS
           ============================================================ */
        .admin-section-bg {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 28px;
        }
        .admin-section-title {
            color: var(--primary);
            font-size: 1.05rem;
            font-weight: 700;
            margin-bottom: 18px;
        }
        .admin-vehicles-list { display: grid; gap: 16px; }
        .delete-vehicle-btn {
            width: 100%;
            padding: 10px;
            background: linear-gradient(135deg, var(--danger), #c0392b);
            border: none;
            border-radius: 8px;
            color: #fff;
            font-weight: 600;
            font-size: .78rem;
            cursor: pointer;
            transition: transform .2s, box-shadow .2s;
            margin-top: 10px;
        }
        .delete-vehicle-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 16px rgba(231,76,90,.35);
        }

        /* ============================================================
           HISTORY MODAL
           ============================================================ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 14px;
            margin-bottom: 24px;
        }
        .stat-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 11px;
            padding: 20px 14px;
            text-align: center;
            transition: border-color .2s, transform .2s;
        }
        .stat-card:hover { border-color: var(--primary); transform: translateY(-2px); }
        .stat-value { font-size: 1.8rem; font-weight: 900; color: var(--primary); margin-bottom: 4px; }
        .stat-label { font-size: .68rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; }

        .filters-section {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 11px;
            padding: 20px;
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 14px;
            align-items: end;
        }
        .export-btn {
            padding: 11px 20px;
            background: linear-gradient(135deg, var(--success), #2ecc71);
            border: none;
            border-radius: 8px;
            color: #fff;
            font-weight: 700;
            font-size: .76rem;
            letter-spacing: .8px;
            text-transform: uppercase;
            cursor: pointer;
            transition: transform .2s, box-shadow .2s;
            white-space: nowrap;
        }
        .export-btn:hover { transform: translateY(-1px); box-shadow: 0 5px 16px rgba(52,195,143,.3); }

        .history-table-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 11px;
            padding: 0;
            overflow-x: auto;
        }
        .history-table { width: 100%; border-collapse: collapse; }
        .history-table th {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            padding: 12px 14px;
            text-align: left;
            font-weight: 700;
            font-size: .68rem;
            letter-spacing: 1px;
            text-transform: uppercase;
            border-bottom: 1px solid var(--border-color);
            position: sticky; top: 0; z-index: 2;
        }
        .history-table td {
            padding: 12px 14px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
            font-size: .82rem;
        }
        .history-table tbody tr { transition: background .18s; }
        .history-table tbody tr:hover { background: var(--card-bg); }
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 14px;
            font-size: .68rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: .5px;
        }
        .status-completed { background: rgba(52,195,143,.15); border: 1px solid var(--success); color: var(--success); }
        .status-active    { background: rgba(79,129,201,.15); border: 1px solid var(--primary); color: var(--primary); }

        /* ============================================================
           RESPONSIVE
           ============================================================ */
        @media (max-width: 768px) {
            .topbar { top: auto; bottom: 80px; right: 16px; flex-direction: column; }
            .theme-rail { top: 16px; left: 16px; }
            .toast-wrap { top: 16px; right: 16px; left: 16px; max-width: none; width: auto; }
            .vehicles-grid { grid-template-columns: 1fr; }
            .modal-content { padding: 22px; }
            header { padding: 56px 16px 32px; }
        }
    </style>
</head>
<body>
<!-- ============================================================
     PUSH NOTIFICATION PERMISSION BANNER
     ============================================================ -->
<div class="push-banner" id="pushBanner">
    <div class="push-banner__icon">üîî</div>
    <div class="push-banner__text">
        <strong>Activer les notifications ?</strong><br>
        Recevez une alerte en temps r√©el chaque fois qu'une r√©servation est cr√©√©e ou termin√©e ‚Äî m√™me si cette page est ferm√©e.
    </div>
    <button class="push-banner__btn" id="pushAcceptBtn">Activer</button>
    <button class="push-banner__dismiss" id="pushDismissBtn">‚úï</button>
</div>

<!-- ============================================================
     IN-PAGE TOAST CONTAINER
     ============================================================ -->
<div class="toast-wrap" id="toastWrap"></div>

<!-- ============================================================
     THEME SWITCHER
     ============================================================ -->
<div class="theme-rail">
    <div class="theme-toggle" id="themeToggle">
        <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="4"/><line x1="12" y1="2" x2="12" y2="4"/><line x1="12" y1="20" x2="12" y2="22"/><line x1="4.93" y1="4.93" x2="6.34" y2="6.34"/><line x1="17.66" y1="17.66" x2="19.07" y2="19.07"/><line x1="2" y1="12" x2="4" y2="12"/><line x1="20" y1="12" x2="22" y2="12"/><line x1="4.93" y1="19.07" x2="6.34" y2="17.66"/><line x1="17.66" y1="6.34" x2="19.07" y2="4.93"/></svg>
    </div>
    <div class="theme-panel" id="themePanel">
        <div class="theme-panel__label">Apparence</div>
        <div class="theme-row active" data-theme="corporate">
            <div class="theme-row__swatch" style="background: linear-gradient(135deg, #0a0e1a 50%, #4f81c9 50%);"></div>
            <span class="theme-row__name">Corporate Steel</span>
        </div>
        <div class="theme-row" data-theme="slate">
            <div class="theme-row__swatch" style="background: linear-gradient(135deg, #f0f2f5 50%, #2c5282 50%);"></div>
            <span class="theme-row__name">Slate Office</span>
        </div>
        <div class="theme-row" data-theme="midnight">
            <div class="theme-row__swatch" style="background: linear-gradient(135deg, #060b16 50%, #38bdf8 50%);"></div>
            <span class="theme-row__name">Midnight Ink</span>
        </div>
        <div class="theme-row" data-theme="gold">
            <div class="theme-row__swatch" style="background: linear-gradient(135deg, #111110 50%, #c3a35c 50%);"></div>
            <span class="theme-row__name">Charcoal Gold</span>
        </div>
        <div class="theme-row" data-theme="teal">
            <div class="theme-row__swatch" style="background: linear-gradient(135deg, #031a1a 50%, #14b8a6 50%);"></div>
            <span class="theme-row__name">Deep Teal</span>
        </div>
        <div class="theme-row" data-theme="wine">
            <div class="theme-row__swatch" style="background: linear-gradient(135deg, #1a1012 50%, #b43f5a 50%);"></div>
            <span class="theme-row__name">Wine & Stone</span>
        </div>
        <div class="theme-row" data-theme="arctic">
            <div class="theme-row__swatch" style="background: linear-gradient(135deg, #f1f5f9 50%, #0369a1 50%);"></div>
            <span class="theme-row__name">Arctic</span>
        </div>
    </div>
</div>

<!-- ============================================================
     TOP BAR
     ============================================================ -->
<div class="topbar">
    <button class="topbar__btn" id="btnAdmin">Admin</button>
    <button class="topbar__btn" id="btnHistory">Historique</button>
</div>

<!-- ============================================================
     MAIN CONTENT
     ============================================================ -->
<div class="container">
    <header>
        <h1>GMR Lorraine</h1>
        <div class="subtitle">Syst√®me de R√©servation de V√©hicules</div>
    </header>
    <div id="vehiclesGrid" class="vehicles-grid"></div>

    <h2 class="section-title">R√©servations Actives</h2>
    <div id="reservationsTimeline">
        <div class="empty-state">
            <div class="empty-state-icon">‚è≥</div>
            <div>Chargement‚Ä¶</div>
        </div>
    </div>
</div>

<!-- ============================================================
     MODAL ‚Äî Admin Login
     ============================================================ -->
<div id="adminLoginModal" class="modal">
    <div class="modal-content" style="max-width:400px;">
        <div class="modal-header" style="flex-direction:column;align-items:center;text-align:center;border-bottom:none;padding-bottom:0;">
            <h2 class="modal-title">Acc√®s Admin</h2>
        </div>
        <div class="form-group">
            <input type="password" id="adminPassword" class="form-input" placeholder="Mot de passe" style="text-align:center;font-size:1rem;">
        </div>
        <button class="submit-btn" id="btnAdminLogin">Se Connecter</button>
    </div>
</div>

<!-- ============================================================
     MODAL ‚Äî Admin Panel
     ============================================================ -->
<div id="adminPanelModal" class="modal">
    <div class="modal-content" style="max-width:860px;">
        <div class="modal-header">
            <h2 class="modal-title">Gestion des V√©hicules</h2>
            <button class="close-btn" id="btnCloseAdmin">√ó</button>
        </div>
        <div class="admin-section-bg">
            <div class="admin-section-title">Ajouter un V√©hicule</div>
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:14px;">
                <div class="form-group"><label class="form-label">Nom</label><input type="text" id="vehicleName" class="form-input" placeholder="Ex: Duster"></div>
                <div class="form-group"><label class="form-label">Plaque</label><input type="text" id="vehiclePlate" class="form-input" placeholder="Ex: FL024LX"></div>
                <div class="form-group"><label class="form-label">Places</label><input type="number" id="vehicleSeats" class="form-input" min="1" max="9" placeholder="5"></div>
                <div class="form-group">
                    <label class="form-label">Type</label>
                    <select id="vehicleType" class="form-select">
                        <option value="">S√©lectionner‚Ä¶</option>
                        <option value="√âlectrique">√âlectrique</option>
                        <option value="Diesel">Diesel</option>
                        <option value="Essence">Essence</option>
                    </select>
                </div>
            </div>
            <button class="submit-btn" id="btnAddVehicle" style="margin-top:16px;">Ajouter le V√©hicule</button>
        </div>
        <div class="admin-section-title">V√©hicules Actuels</div>
        <div id="adminVehiclesList" class="admin-vehicles-list"></div>
    </div>
</div>

<!-- ============================================================
     MODAL ‚Äî R√©servation
     ============================================================ -->
<div id="reservationModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">R√©server un v√©hicule</h2>
            <button class="close-btn" id="btnCloseRes">√ó</button>
        </div>
        <div class="form-group"><label class="form-label">Nom du salari√©</label><input type="text" id="employeeName" class="form-input"></div>
        <div class="form-group"><label class="form-label">Date</label><input type="date" id="reservationDate" class="form-input"></div>
        <div class="form-group"><label class="form-label">Heure de d√©part</label><div id="startTimeSlots" class="time-slots-container"></div></div>
        <div class="form-group"><label class="form-label">Heure de retour</label><div id="endTimeSlots" class="time-slots-container"></div></div>
        <div class="form-group"><label class="form-label">Destination</label><input type="text" id="destination" class="form-input"></div>
        <div class="form-group"><label class="form-label">Motif (optionnel)</label><input type="text" id="motif" class="form-input"></div>
        <div class="form-group"><label class="form-label">Mot de passe de protection</label><input type="password" id="protectionPassword" class="form-input" placeholder="Cr√©ez un mot de passe‚Ä¶"></div>
        <button class="submit-btn" id="btnSubmitRes">Confirmer la r√©servation</button>
    </div>
</div>

<!-- ============================================================
     MODAL ‚Äî D√©verrouillage
     ============================================================ -->
<div id="unlockModal" class="modal">
    <div class="modal-content" style="max-width:420px;">
        <div class="modal-header">
            <h2 class="modal-title">D√©verrouiller</h2>
            <button class="close-btn" id="btnCloseUnlock">√ó</button>
        </div>
        <div class="form-group"><label class="form-label">Mot de passe de protection</label><input type="password" id="unlockPassword" class="form-input"></div>
        <button class="submit-btn" id="btnSubmitUnlock">Terminer la r√©servation</button>
    </div>
</div>

<!-- ============================================================
     MODAL ‚Äî Historique
     ============================================================ -->
<div id="historyModal" class="modal">
    <div class="modal-content" style="max-width:1100px;">
        <div class="modal-header">
            <h2 class="modal-title">Historique des R√©servations</h2>
            <button class="close-btn" id="btnCloseHistory">√ó</button>
        </div>
        <div class="stats-grid">
            <div class="stat-card"><div class="stat-value" id="totalReservations">0</div><div class="stat-label">Total</div></div>
            <div class="stat-card"><div class="stat-value" id="activeReservations">0</div><div class="stat-label">En Cours</div></div>
            <div class="stat-card"><div class="stat-value" id="completedReservations">0</div><div class="stat-label">Compl√©t√©es</div></div>
            <div class="stat-card"><div class="stat-value" id="mostUsedVehicle">‚Äî</div><div class="stat-label">Plus utilis√©</div></div>
        </div>
        <div class="filters-section">
            <div class="form-group" style="margin-bottom:0;"><label class="form-label">Date d√©but</label><input type="date" id="filterStartDate" class="form-input"></div>
            <div class="form-group" style="margin-bottom:0;"><label class="form-label">Date fin</label><input type="date" id="filterEndDate" class="form-input"></div>
            <div class="form-group" style="margin-bottom:0;"><label class="form-label">V√©hicule</label><select id="filterVehicle" class="form-select"><option value="">Tous</option></select></div>
            <div class="form-group" style="margin-bottom:0;"><label class="form-label">Salari√©</label><input type="text" id="filterEmployee" class="form-input" placeholder="Nom‚Ä¶"></div>
            <button class="export-btn" id="btnExport">Exporter Excel</button>
        </div>
        <div class="history-table-container">
            <table class="history-table">
                <thead><tr><th>Date</th><th>V√©hicule</th><th>Salari√©</th><th>Horaires</th><th>Destination</th><th>Motif</th><th>Statut</th></tr></thead>
                <tbody id="historyTableBody"><tr><td colspan="7" style="text-align:center;padding:36px;color:var(--text-secondary);">Chargement‚Ä¶</td></tr></tbody>
            </table>
        </div>
    </div>
</div>

<!-- ============================================================
     APPLICATION SCRIPT
     ============================================================ -->
<script type="module">
import { initializeApp }                                           from 'https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js';
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, orderBy } from 'https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js';
import { getMessaging, getToken, onMessage }                      from 'https://www.gstatic.com/firebasejs/12.8.0/firebase-messaging.js';

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   FIREBASE INIT
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const firebaseConfig = {
    apiKey:            "AIzaSyDDFzYGVZXmJOWy7XIOO4CmBfPvlJsWFCs",
    authDomain:        "rte-reservation-vehicule.firebaseapp.com",
    projectId:         "rte-reservation-vehicule",
    storageBucket:     "rte-reservation-vehicule.firebasestorage.app",
    messagingSenderId: "56823546993",
    appId:             "1:56823546993:web:b1e54fbbc9fe99f5b907d0"
};

const app  = initializeApp(firebaseConfig);
const db   = getFirestore(app);
const fcm  = getMessaging(app);

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   VAPID KEY  ‚Äî remplacez par votre cl√© r√©elle
   dans Firebase Console > Cloud Messaging > Web Push certificates
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const VAPID_KEY = "YOUR_VAPID_KEY_HERE";

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   PUSH NOTIFICATIONS ‚Äî permission & token
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const pushBanner   = document.getElementById('pushBanner');
const pushAccept   = document.getElementById('pushAcceptBtn');
const pushDismiss  = document.getElementById('pushDismissBtn');

async function initPushNotifications() {
    // Si d√©j√† accord√©, enregistrer le token silencieusement
    if (Notification.permission === 'granted') {
        await registerFCMToken();
        return;
    }
    // Si pas encore demand√© ‚Üí afficher la banni√®re
    if (Notification.permission === 'default') {
        pushBanner.classList.add('visible');
    }
    // Si refus√© ‚Üí on ne montre rien
}

pushAccept.addEventListener('click', async () => {
    pushBanner.classList.remove('visible');
    const perm = await Notification.requestPermission();
    if (perm === 'granted') {
        await registerFCMToken();
        toast('success', 'Notifications activ√©es', 'Vous recevrez les alertes en temps r√©el.');
    } else {
        toast('warning', 'Permission refus√©e', 'Les notifications restent d√©sactiv√©es.');
    }
});

pushDismiss.addEventListener('click', () => {
    pushBanner.classList.remove('visible');
});

async function registerFCMToken() {
    try {
        const token = await getToken(fcm, { vapidKey: VAPID_KEY });
        if (token) {
            // Stocker le token dans Firestore pour l'envoyer depuis un backend
            await addDoc(collection(db, 'fcm_tokens'), {
                token:     token,
                createdAt: new Date().toISOString()
            });
            console.log('[FCM] Token enregistr√© :', token);
        }
    } catch (err) {
        console.warn('[FCM] Impossible d\'obtenir le token :', err);
    }
}

// Messages re√ßus PENDANT que la page est ouverte (foreground)
onMessage(fcm, (payload) => {
    console.log('[FCM Foreground]', payload);
    const title = payload.notification?.title || 'GMR Lorraine';
    const body  = payload.notification?.body  || '';

    // D√©terminer le type de toast
    let type = 'info';
    if (body.toLowerCase().includes('nouvelle r√©servation')) type = 'success';
    if (body.toLowerCase().includes('termin√©e') || body.toLowerCase().includes('lib√©r√©')) type = 'warning';

    toast(type, title, body);
});

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   TOAST SYSTEM  (in-page)
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const toastWrap = document.getElementById('toastWrap');
const ICONS = { success: '‚úì', error: '‚úï', warning: '‚ö†', info: '‚Ñπ' };

function toast(type, title, msg) {
    const el = document.createElement('div');
    el.className = `toast ${type}`;
    el.innerHTML = `
        <div class="toast__icon">${ICONS[type]||'‚Ñπ'}</div>
        <div class="toast__body">
            <div class="toast__title">${title}</div>
            <div class="toast__msg">${msg}</div>
        </div>
        <button class="toast__close">√ó</button>
    `;
    el.querySelector('.toast__close').addEventListener('click', () => dismissToast(el));
    toastWrap.appendChild(el);
    setTimeout(() => dismissToast(el), 5200);
}

function dismissToast(el) {
    if (!el.parentNode) return;
    el.classList.add('out');
    el.addEventListener('animationend', () => el.remove(), { once: true });
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   THEME SYSTEM
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const themeToggle = document.getElementById('themeToggle');
const themePanel  = document.getElementById('themePanel');
const themeRows   = document.querySelectorAll('.theme-row');

themeToggle.addEventListener('click', (e) => {
    e.stopPropagation();
    themePanel.classList.toggle('open');
});
document.addEventListener('click', (e) => {
    if (!themePanel.contains(e.target) && e.target !== themeToggle)
        themePanel.classList.remove('open');
});

function applyTheme(name) {
    themeRows.forEach(r => r.classList.remove('active'));
    const row = document.querySelector(`.theme-row[data-theme="${name}"]`);
    if (row) row.classList.add('active');
    if (name === 'corporate') document.documentElement.removeAttribute('data-theme');
    else document.documentElement.setAttribute('data-theme', name);
    localStorage.setItem('gmr_theme', name);
    themePanel.classList.remove('open');
}

themeRows.forEach(row => {
    row.addEventListener('click', () => applyTheme(row.dataset.theme));
});

// Restaurer th√®me sauvegard√©
(function() {
    const saved = localStorage.getItem('gmr_theme') || 'corporate';
    applyTheme(saved);
})();

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   GLOBALS
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
let vehicles            = [];
let currentReservations = [];
let allHistoryLogs      = [];
let selectedVehicle     = null;
let selectedStartTime   = null;
let selectedEndTime     = null;
let selectedDate        = null;
let currentUnlockRes    = null;

const ADMIN_HASH = "7c3504aefae880c790748706f3da821868a943e8fc411760f92e4631e9a1064c";
const TIME_SLOTS = [];
for (let h = 7; h <= 20; h++) TIME_SLOTS.push(`${String(h).padStart(2,'0')}:00`);

async function hashPassword(pw) {
    const buf  = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(pw));
    return [...new Uint8Array(buf)].map(b => b.toString(16).padStart(2,'0')).join('');
}

function formatDate(s) {
    return new Date(s).toLocaleDateString('fr-FR', { weekday:'long', day:'2-digit', month:'long', year:'numeric' });
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   SEND PUSH TO ALL STORED TOKENS  (client-side helper)
   In production, move this to a Cloud Function / backend.
   Here it reads tokens from Firestore and calls the FCM HTTP v1 API.
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
async function sendPushToAll(title, body, tag) {
    try {
        const snap = await getDocs(collection(db, 'fcm_tokens'));
        const tokens = [];
        snap.forEach(d => tokens.push(d.data().token));

        for (const token of tokens) {
            // NOTE: In production use a backend (Cloud Function) to send FCM messages.
            // Direct HTTP calls from the browser require the FCM server key, which should never be in client code.
            // This placeholder logs the intent; wire up your backend endpoint here.
            console.log('[FCM] Would send to token:', token, { title, body, tag });
        }
    } catch (e) {
        console.warn('[FCM] sendPushToAll error:', e);
    }
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   VEHICLES  ‚Äî load / display
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
async function loadVehicles() {
    try {
        const snap = await getDocs(collection(db, 'vehicles'));
        vehicles = [];
        snap.forEach(d => vehicles.push({ id: d.id, ...d.data() }));
        if (vehicles.length === 0) await initDefaultVehicles();
        renderVehicles();
    } catch (e) {
        console.error(e);
        toast('error', 'Erreur', 'Impossible de charger les v√©hicules.');
    }
}

async function initDefaultVehicles() {
    const defaults = [
        { name:'Duster',  plate:'FL024LX', seats:2, type:'Diesel',      icon:'' },
        { name:'M√©gane',  plate:'HC453LH', seats:5, type:'√âlectrique',  icon:'' },
        { name:'Corolla', plate:'FX466BC', seats:5, type:'Essence',     icon:'' }
    ];
    for (const v of defaults) await addDoc(collection(db, 'vehicles'), v);
    await loadVehicles();
}

function renderVehicles() {
    document.getElementById('vehiclesGrid').innerHTML = vehicles.map(v => `
        <div class="vehicle-card" data-id="${v.id}">
            <div class="vehicle-header">
                <div class="vehicle-name">${v.name}</div>
                <div class="vehicle-badge">${v.type}</div>
            </div>
            <div class="vehicle-info">
                <div class="info-item"><div class="info-label">Plaque</div><div class="info-value">${v.plate}</div></div>
                <div class="info-item"><div class="info-label">Places</div><div class="info-value">${v.seats}</div></div>
            </div>
            <button class="reserve-btn">R√©server</button>
        </div>
    `).join('');

    // Del√©gation d'√©v√©nements
    document.getElementById('vehiclesGrid').querySelectorAll('.vehicle-card').forEach(card => {
        card.addEventListener('click', () => openReservationModal(card.dataset.id));
    });
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   ADMIN PANEL
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
document.getElementById('btnAdmin').addEventListener('click', () => {
    document.getElementById('adminLoginModal').classList.add('active');
    document.getElementById('adminPassword').focus();
});

document.getElementById('btnAdminLogin').addEventListener('click', async () => {
    const pw = document.getElementById('adminPassword').value;
    if (await hashPassword(pw) !== ADMIN_HASH) {
        toast('error', 'Erreur', 'Mot de passe incorrect.');
        return;
    }
    document.getElementById('adminLoginModal').classList.remove('active');
    document.getElementById('adminPassword').value = '';
    document.getElementById('adminPanelModal').classList.add('active');
    renderAdminVehicles();
    toast('success', 'Connect√©', 'Acc√®s admin autoris√©.');
});

document.getElementById('btnCloseAdmin').addEventListener('click', () => {
    document.getElementById('adminPanelModal').classList.remove('active');
});

// Fermer login modal en cliquant l'arri√®re-plan
document.getElementById('adminLoginModal').addEventListener('click', (e) => {
    if (e.target === e.currentTarget) {
        e.currentTarget.classList.remove('active');
        document.getElementById('adminPassword').value = '';
    }
});

function renderAdminVehicles() {
    document.getElementById('adminVehiclesList').innerHTML = vehicles.map(v => `
        <div class="vehicle-card">
            <div class="vehicle-header">
                <div class="vehicle-name">${v.name}</div>
                <div class="vehicle-badge">${v.type}</div>
            </div>
            <div class="vehicle-info">
                <div class="info-item"><div class="info-label">Plaque</div><div class="info-value">${v.plate}</div></div>
                <div class="info-item"><div class="info-label">Places</div><div class="info-value">${v.seats}</div></div>
            </div>
            <button class="delete-vehicle-btn" data-id="${v.id}">Supprimer</button>
        </div>
    `).join('');

    document.getElementById('adminVehiclesList').querySelectorAll('.delete-vehicle-btn').forEach(btn => {
        btn.addEventListener('click', () => deleteVehicle(btn.dataset.id));
    });
}

document.getElementById('btnAddVehicle').addEventListener('click', async () => {
    const name  = document.getElementById('vehicleName').value.trim();
    const plate = document.getElementById('vehiclePlate').value.trim().toUpperCase();
    const seats = document.getElementById('vehicleSeats').value;
    const type  = document.getElementById('vehicleType').value;
    if (!name || !plate || !seats || !type) { toast('warning','Champs manquants','Remplissez tous les champs.'); return; }

    try {
        await addDoc(collection(db, 'vehicles'), { name, plate, seats: parseInt(seats), type, icon: '' });
        ['vehicleName','vehiclePlate','vehicleSeats','vehicleType'].forEach(id => {
            const el = document.getElementById(id);
            el.value = '';
        });
        await loadVehicles();
        renderAdminVehicles();
        toast('success', 'V√©hicule ajout√©', `${name} a √©t√© enregistr√©.`);
    } catch (e) {
        toast('error', 'Erreur', 'Impossible d\'ajouter le v√©hicule.');
    }
});

async function deleteVehicle(id) {
    if (!confirm('Supprimer ce v√©hicule ?')) return;
    try {
        await deleteDoc(doc(db, 'vehicles', id));
        await loadVehicles();
        renderAdminVehicles();
        toast('success', 'Supprim√©', 'Le v√©hicule a √©t√© supprim√©.');
    } catch (e) {
        toast('error', 'Erreur', 'Impossible de supprimer.');
    }
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   RESERVATION MODAL
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function openReservationModal(vehicleId) {
    selectedVehicle    = vehicles.find(v => v.id === vehicleId);
    selectedStartTime  = null;
    selectedEndTime    = null;
    const today        = new Date().toISOString().split('T')[0];
    document.getElementById('reservationDate').value = today;
    document.getElementById('reservationDate').min   = today;
    selectedDate = today;
    document.getElementById('reservationModal').classList.add('active');
    renderTimeSlots();
    updateTimeSlots();
}

document.getElementById('btnCloseRes').addEventListener('click', closeReservationModal);
document.getElementById('reservationModal').addEventListener('click', (e) => {
    if (e.target === e.currentTarget) closeReservationModal();
});

function closeReservationModal() {
    document.getElementById('reservationModal').classList.remove('active');
    ['employeeName','destination','motif','protectionPassword'].forEach(id => document.getElementById(id).value = '');
    selectedVehicle = selectedStartTime = selectedEndTime = selectedDate = null;
}

document.getElementById('reservationDate').addEventListener('change', (e) => {
    selectedDate = e.target.value;
    selectedStartTime = selectedEndTime = null;
    updateTimeSlots();
});

function renderTimeSlots() {
    document.getElementById('startTimeSlots').innerHTML = TIME_SLOTS.map(t =>
        `<div class="time-slot" data-time="${t}">${t}</div>`
    ).join('');
    document.getElementById('endTimeSlots').innerHTML   = TIME_SLOTS.map(t =>
        `<div class="time-slot" data-time="${t}">${t}</div>`
    ).join('');

    // D√©l√©gation
    document.getElementById('startTimeSlots').addEventListener('click', (e) => {
        const slot = e.target.closest('.time-slot');
        if (!slot || slot.classList.contains('occupied') || slot.classList.contains('disabled')) return;
        selectStartTime(slot.dataset.time);
    });
    document.getElementById('endTimeSlots').addEventListener('click', (e) => {
        const slot = e.target.closest('.time-slot');
        if (!slot || slot.classList.contains('occupied') || slot.classList.contains('disabled')) return;
        selectEndTime(slot.dataset.time);
    });
}

function getOccupiedSlots(vehicleId, date) {
    const slots = [];
    currentReservations
        .filter(r => r.vehicleId === vehicleId && r.date === date)
        .forEach(r => {
            const s = parseInt(r.startTime.split(':')[0]);
            const e = parseInt(r.endTime.split(':')[0]);
            for (let h = s; h < e; h++) slots.push(`${String(h).padStart(2,'0')}:00`);
        });
    return slots;
}

function updateTimeSlots() {
    if (!selectedVehicle || !selectedDate) return;
    const occupied = getOccupiedSlots(selectedVehicle.id, selectedDate);

    document.querySelectorAll('#startTimeSlots .time-slot').forEach(slot => {
        slot.classList.remove('occupied','disabled','selected');
        if (occupied.includes(slot.dataset.time)) slot.classList.add('occupied');
    });
    updateEndTimeSlots();
}

function updateEndTimeSlots() {
    if (!selectedVehicle || !selectedDate) return;
    const occupied = getOccupiedSlots(selectedVehicle.id, selectedDate);

    document.querySelectorAll('#endTimeSlots .time-slot').forEach(slot => {
        slot.classList.remove('occupied','disabled','selected');
        if (!selectedStartTime) { slot.classList.add('disabled'); return; }

        const cur   = parseInt(slot.dataset.time.split(':')[0]);
        const start = parseInt(selectedStartTime.split(':')[0]);
        if (cur <= start) { slot.classList.add('disabled'); return; }

        // Check if any hour between start and cur is occupied
        for (let h = start; h < cur; h++) {
            if (occupied.includes(`${String(h).padStart(2,'0')}:00`)) { slot.classList.add('disabled'); return; }
        }
    });
}

function selectStartTime(time) {
    selectedStartTime = time;
    selectedEndTime   = null;
    document.querySelectorAll('#startTimeSlots .time-slot').forEach(s => s.classList.remove('selected'));
    document.querySelectorAll('#endTimeSlots .time-slot').forEach(s => s.classList.remove('selected'));
    document.querySelector(`#startTimeSlots .time-slot[data-time="${time}"]`).classList.add('selected');
    updateEndTimeSlots();
}

function selectEndTime(time) {
    if (time <= selectedStartTime) { toast('warning','Erreur horaire','L\'heure de retour doit √™tre apr√®s le d√©part.'); return; }
    selectedEndTime = time;
    document.querySelectorAll('#endTimeSlots .time-slot').forEach(s => s.classList.remove('selected'));
    document.querySelector(`#endTimeSlots .time-slot[data-time="${time}"]`).classList.add('selected');
}

document.getElementById('btnSubmitRes').addEventListener('click', async () => {
    const name = document.getElementById('employeeName').value.trim();
    const dest = document.getElementById('destination').value.trim();
    const pw   = document.getElementById('protectionPassword').value;

    if (!name)            { toast('warning','Champ requis','Entrez votre nom.'); return; }
    if (!selectedStartTime || !selectedEndTime) { toast('warning','Horaires manquants','S√©lectionnez les heures de d√©part et de retour.'); return; }
    if (!dest)            { toast('warning','Champ requis','Entrez la destination.'); return; }
    if (!pw)              { toast('warning','Champ requis','Cr√©ez un mot de passe.'); return; }

    const reservation = {
        vehicleId:     selectedVehicle.id,
        vehicleName:   selectedVehicle.name,
        vehiclePlate:  selectedVehicle.plate,
        vehicleIcon:   selectedVehicle.icon || '',
        employeeName:  name,
        date:          selectedDate,
        startTime:     selectedStartTime,
        endTime:       selectedEndTime,
        destination:   dest,
        motif:         document.getElementById('motif').value.trim(),
        passwordHash:  await hashPassword(pw),
        createdAt:     new Date().toISOString(),
        status:        'active'
    };

    try {
        await addDoc(collection(db, 'reservations'), reservation);

        // ‚îÄ‚îÄ Envoyer notification push √† tous les abonn√©s ‚îÄ‚îÄ
        sendPushToAll(
            'Nouvelle r√©servation',
            `${name} a r√©serv√© le ${selectedVehicle.name} (${selectedStartTime} ‚Üí ${selectedEndTime})`,
            'gmr-reservation-new'
        );

        closeReservationModal();
        await loadReservations();
        toast('success', 'R√©servation confirm√©e', `${selectedVehicle.name} r√©serv√© de ${selectedStartTime} √† ${selectedEndTime}.`);
    } catch (e) {
        console.error(e);
        toast('error', 'Erreur', 'Impossible de cr√©er la r√©servation.');
    }
});

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   RESERVATIONS ‚Äî load / display
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
async function loadReservations() {
    try {
        const q    = query(collection(db, 'reservations'), orderBy('date', 'desc'));
        const snap = await getDocs(q);
        currentReservations = [];
        snap.forEach(d => currentReservations.push({ id: d.id, ...d.data() }));
        currentReservations = currentReservations.filter(r => r.status === 'active');
        currentReservations.sort((a, b) => a.date !== b.date ? b.date.localeCompare(a.date) : b.startTime.localeCompare(a.startTime));
        renderReservations();
    } catch (e) {
        console.error(e);
        document.getElementById('reservationsTimeline').innerHTML = `
            <div class="empty-state"><div class="empty-state-icon">‚ö†</div><div>Erreur de chargement</div></div>`;
    }
}

function renderReservations() {
    const el = document.getElementById('reservationsTimeline');
    if (currentReservations.length === 0) {
        el.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üì≠</div><div>Aucune r√©servation active</div></div>`;
        return;
    }
    el.innerHTML = currentReservations.map(r => `
        <div class="reservation-card">
            <div class="reservation-header">
                <div class="reservation-vehicle-info">
                    <div class="vehicle-icon">${r.vehicleIcon||'üöó'}</div>
                    <div class="vehicle-details">
                        <h3>${r.vehicleName}</h3>
                        <span class="vehicle-plate">${r.vehiclePlate}</span>
                    </div>
                </div>
                <div class="reservation-status">En Cours</div>
            </div>
            <div class="reservation-body">
                <div class="reservation-info-block"><h4>Salari√©</h4><p>${r.employeeName}</p></div>
                <div class="reservation-info-block"><h4>Date</h4><p>${formatDate(r.date)}</p></div>
                <div class="reservation-info-block"><h4>Horaires</h4><div class="time-range"><span>${r.startTime}</span><span class="time-arrow">‚Üí</span><span>${r.endTime}</span></div></div>
                <div class="reservation-info-block reservation-destination"><h4>Destination</h4><p>${r.destination}</p></div>
                ${r.motif ? `<div class="reservation-info-block"><h4>Motif</h4><p>${r.motif}</p></div>` : ''}
            </div>
            <div class="reservation-actions">
                <button class="unlock-btn" data-id="${r.id}">Terminer & Lib√©rer</button>
            </div>
        </div>
    `).join('');

    el.querySelectorAll('.unlock-btn').forEach(btn => {
        btn.addEventListener('click', () => openUnlockModal(btn.dataset.id));
    });
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   UNLOCK MODAL
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function openUnlockModal(resId) {
    currentUnlockRes = currentReservations.find(r => r.id === resId);
    document.getElementById('unlockPassword').value = '';
    document.getElementById('unlockModal').classList.add('active');
}

document.getElementById('btnCloseUnlock').addEventListener('click', () => {
    document.getElementById('unlockModal').classList.remove('active');
    currentUnlockRes = null;
});
document.getElementById('unlockModal').addEventListener('click', (e) => {
    if (e.target === e.currentTarget) { e.currentTarget.classList.remove('active'); currentUnlockRes = null; }
});

document.getElementById('btnSubmitUnlock').addEventListener('click', async () => {
    const pw = document.getElementById('unlockPassword').value;
    if (await hashPassword(pw) !== currentUnlockRes.passwordHash) {
        toast('error', 'Erreur', 'Mot de passe incorrect.'); return;
    }
    try {
        const completed = { ...currentUnlockRes, status: 'completed', completedAt: new Date().toISOString() };
        await deleteDoc(doc(db, 'reservations', currentUnlockRes.id));
        await addDoc(collection(db, 'reservations'), completed);

        // ‚îÄ‚îÄ Notification push ‚îÄ‚îÄ
        sendPushToAll(
            'R√©servation termin√©e',
            `Le ${currentUnlockRes.vehicleName} a √©t√© lib√©r√© par ${currentUnlockRes.employeeName}.`,
            'gmr-reservation-done'
        );

        document.getElementById('unlockModal').classList.remove('active');
        currentUnlockRes = null;
        await loadReservations();
        toast('success', 'R√©servation termin√©e', 'Le v√©hicule est disponible.');
    } catch (e) {
        toast('error', 'Erreur', 'Impossible de terminer la r√©servation.');
    }
});

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   HISTORY
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
document.getElementById('btnHistory').addEventListener('click', async () => {
    document.getElementById('historyModal').classList.add('active');
    await loadHistory();
});
document.getElementById('btnCloseHistory').addEventListener('click', () => {
    document.getElementById('historyModal').classList.remove('active');
});
document.getElementById('historyModal').addEventListener('click', (e) => {
    if (e.target === e.currentTarget) e.currentTarget.classList.remove('active');
});

async function loadHistory() {
    try {
        const q    = query(collection(db, 'reservations'), orderBy('createdAt', 'desc'));
        const snap = await getDocs(q);
        allHistoryLogs = [];
        snap.forEach(d => allHistoryLogs.push({ id: d.id, ...d.data() }));
        allHistoryLogs.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
        updateStatistics();
        populateVehicleFilter();
        applyFilters();
    } catch (e) {
        console.error(e);
        document.getElementById('historyTableBody').innerHTML = `<tr><td colspan="7" style="text-align:center;padding:36px;color:var(--text-secondary);">Erreur</td></tr>`;
    }
}

function updateStatistics() {
    const total     = allHistoryLogs.length;
    const active    = allHistoryLogs.filter(r => r.status === 'active').length;
    const completed = allHistoryLogs.filter(r => r.status === 'completed').length;

    const cnt = {};
    allHistoryLogs.forEach(l => cnt[l.vehicleName] = (cnt[l.vehicleName]||0)+1);
    let most = '‚Äî';
    let max  = 0;
    Object.entries(cnt).forEach(([v,c]) => { if (c > max) { max = c; most = v; } });

    document.getElementById('totalReservations').textContent     = total;
    document.getElementById('activeReservations').textContent    = active;
    document.getElementById('completedReservations').textContent = completed;
    document.getElementById('mostUsedVehicle').textContent       = most;
}

function populateVehicleFilter() {
    const sel     = document.getElementById('filterVehicle');
    const uniques = [...new Set(allHistoryLogs.map(l => l.vehicleName))];
    sel.innerHTML = '<option value="">Tous</option>' + uniques.map(v => `<option value="${v}">${v}</option>`).join('');
}

function applyFilters() {
    const sd  = document.getElementById('filterStartDate').value;
    const ed  = document.getElementById('filterEndDate').value;
    const vf  = document.getElementById('filterVehicle').value;
    const ef  = document.getElementById('filterEmployee').value.toLowerCase();

    const filtered = allHistoryLogs.filter(l => {
        if (sd && l.date < sd) return false;
        if (ed && l.date > ed) return false;
        if (vf && l.vehicleName !== vf) return false;
        if (ef && !l.employeeName.toLowerCase().includes(ef)) return false;
        return true;
    });
    renderHistoryTable(filtered);
}

['filterStartDate','filterEndDate','filterVehicle','filterEmployee'].forEach(id => {
    document.getElementById(id).addEventListener('input', applyFilters);
    document.getElementById(id).addEventListener('change', applyFilters);
});

function renderHistoryTable(logs) {
    const tbody = document.getElementById('historyTableBody');
    if (!logs.length) {
        tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;padding:36px;color:var(--text-secondary);">Aucune r√©servation trouv√©e</td></tr>`;
        return;
    }
    tbody.innerHTML = logs.map(l => `
        <tr>
            <td>${formatDate(l.date)}</td>
            <td><div style="display:flex;align-items:center;gap:8px;"><span style="font-size:1.3rem;">${l.vehicleIcon||'üöó'}</span><div><div style="font-weight:600;">${l.vehicleName}</div><div style="font-size:.75rem;color:var(--text-secondary);">${l.vehiclePlate}</div></div></div></td>
            <td>${l.employeeName}</td>
            <td><div style="display:flex;align-items:center;gap:6px;">${l.startTime}<span style="color:var(--primary);">‚Üí</span>${l.endTime}</div></td>
            <td>${l.destination}</td>
            <td>${l.motif||'‚Äî'}</td>
            <td><span class="status-badge ${l.status==='completed'?'status-completed':'status-active'}">${l.status==='completed'?'Compl√©t√©e':'En Cours'}</span></td>
        </tr>
    `).join('');
}

document.getElementById('btnExport').addEventListener('click', () => {
    const sd  = document.getElementById('filterStartDate').value;
    const ed  = document.getElementById('filterEndDate').value;
    const vf  = document.getElementById('filterVehicle').value;
    const ef  = document.getElementById('filterEmployee').value.toLowerCase();

    const filtered = allHistoryLogs.filter(l => {
        if (sd && l.date < sd) return false;
        if (ed && l.date > ed) return false;
        if (vf && l.vehicleName !== vf) return false;
        if (ef && !l.employeeName.toLowerCase().includes(ef)) return false;
        return true;
    });

    if (!filtered.length) { toast('warning','Aucune donn√©e','Aucune r√©servation √† exporter.'); return; }

    const headers = ['Date','V√©hicule','Plaque','Salari√©','Heure D√©but','Heure Fin','Destination','Motif','Statut'];
    let csv = '\uFEFF' + headers.join(';') + '\n';
    filtered.forEach(l => {
        csv += [formatDate(l.date), l.vehicleName, l.vehiclePlate, l.employeeName, l.startTime, l.endTime, l.destination, l.motif||'-', l.status==='completed'?'Compl√©t√©e':'En Cours']
            .map(c => `"${c}"`).join(';') + '\n';
    });

    const link = document.createElement('a');
    link.href  = URL.createObjectURL(new Blob([csv], { type:'text/csv;charset=utf-8;' }));
    link.download = `historique_gmr_${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    toast('success', 'Export r√©ussi', `${filtered.length} r√©servation(s) export√©e(s).`);
});

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   BOOT
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
loadVehicles();
loadReservations();
setInterval(loadReservations, 28000);
initPushNotifications();
</script>
</body>
</html>
